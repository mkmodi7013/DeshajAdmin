<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monthly Register</title>

<style>
body{
  font-family: Arial;
  background:#f7f7f7;
  padding:20px;
}

h2{text-align:center}

#searchInput{
  width:100%;
  max-width:400px;
  padding:8px;
  margin:10px auto 20px;
  display:block;
  border:1px solid #ccc;
  border-radius:5px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
}

th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}

th{
  background:orange;
  color:#fff;
}

td.name{
  font-weight:bold;
}

tr:nth-child(even){
  background:#f9f9f9;
}

/* ===== INPUT STYLE ===== */
.month-input{
  width:60px;
  padding:4px;
  text-align:center;
  font-weight:bold;
  color:green;
  caret-color:green;
}

/* remove number arrows */
.month-input::-webkit-outer-spin-button,
.month-input::-webkit-inner-spin-button{
  -webkit-appearance:none;
  margin:0;
}


.month-input:focus{
  outline:2px solid green;
}

/* ===== BUTTONS ===== */
.action-btn{
  padding:4px 8px;
  border:none;
  border-radius:4px;
  color:#fff;
  cursor:pointer;
}
.edit{background:#1a0af7}
.delete{background:#f44336}
</style>
</head>

<body>

<h2>Monthly Register</h2>

<input id="searchInput" placeholder="Search name / mobile / address">

<table id="usersTable">
<thead>
<tr>
<th>#</th>
<th>Name</th>
<th>Mobile</th>
<th>Address</th>
<th>Nov 25</th>
<th>Dec 25</th>
<th>Jan 26</th>
<th>Feb 26</th>
<th>Mar 26</th>
<th>Apr 26</th>
<th>May 26</th>
<th>Jun 26</th>
<th>Jul 26</th>
<th>Aug 26</th>
<th>Sep 26</th>
<th>Oct 26</th>
<th>Total</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  doc, getDoc, setDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyA6izuR2_oyHbAVhkIVkH0OHj6yAOduD_8",
  authDomain:"apna-kitchen-acdcc.firebaseapp.com",
  projectId:"apna-kitchen-acdcc"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const PRICE=200;
const months=[
"nov25","dec25","jan26","feb26","mar26","apr26",
"may26","jun26","jul26","aug26","sep26","oct26"
];

const tbody=document.querySelector("#usersTable tbody");

/* ===== LOAD USERS ===== */
const snap=await getDocs(collection(db,"users"));
let users=snap.docs.map(d=>({id:d.id,...d.data()}));

for(let i=0;i<users.length;i++){
  const u=users[i];
  const mSnap=await getDoc(doc(db,"month_register",u.id));
  const mData=mSnap.exists()?mSnap.data():{};
  let total=0;

  let row=document.createElement("tr");
  row.innerHTML=`
    <td>${i+1}</td>
    <td class="name">${u.name||""}</td>
    <td>${u.mobile||""}</td>
    <td>${u.address||""}</td>
  `;

  months.forEach(m=>{
    const amt=mData[m]||0;
    total+=amt;
    const td=document.createElement("td");
    td.innerHTML=`
      <input type="number" class="month-input"
        value="${amt?amt/PRICE:""}"
        onblur="saveMonth('${u.id}','${m}',this.value)">
    `;
    row.appendChild(td);
  });

  row.innerHTML+=`
    <td id="total-${u.id}">${total}</td>
    <td>
      <button class="action-btn edit">Edit</button>
      <button class="action-btn delete"
        onclick="deleteUser('${u.id}')">Delete</button>
    </td>
  `;

  tbody.appendChild(row);
}

/* ===== SAVE MONTH ===== */
window.saveMonth=async(uid,month,val)=>{
  const num=parseInt(val)||0;
  await setDoc(
    doc(db,"month_register",uid),
    {[month]:num*PRICE},
    {merge:true}
  );

  let total=0;
  const snap=await getDoc(doc(db,"month_register",uid));
  if(snap.exists()){
    Object.values(snap.data()).forEach(v=>total+=v);
  }
  document.getElementById("total-"+uid).innerText=total;
};

/* ===== DELETE ===== */
window.deleteUser=async(id)=>{
  if(confirm("Delete user?")){
    await deleteDoc(doc(db,"users",id));
    location.reload();
  }
};

/* ===== SEARCH (NO RE-RENDER) ===== */
document.getElementById("searchInput").addEventListener("input",function(){
  const val=this.value.toLowerCase();
  document.querySelectorAll("#usersTable tbody tr").forEach(r=>{
    r.style.display=r.innerText.toLowerCase().includes(val)?"":"none";
  });
});
</script>

</body>
</html>
