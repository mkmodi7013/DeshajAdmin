<!-- admin-stock.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin - Stock Management</title>
<style>
  body{font-family:Arial;background:#f7f7f7;padding:18px}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;max-width:1100px;margin:0 auto}
  h2{margin:6px 0}
  .controls{display:flex;gap:8px;align-items:center}
  select,input{padding:10px;border-radius:6px;border:1px solid #ccc}
  button{padding:10px 12px;border-radius:6px;border:0;background:orange;color:#fff;cursor:pointer}
  .box{max-width:1100px;margin:14px auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #eee;padding:10px;text-align:center}
  th{background:orange;color:#fff}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:red;color:#fff;font-weight:700}
  .status{padding:6px 10px;border-radius:8px;color:#fff}
  .in-stock{background:green}.low-stock{background:#d68910}.out-stock{background:red}
  .actions button{margin:0 4px;padding:6px 8px}
  .small{font-size:13px;color:#666}
  .history-list{max-height:300px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px;background:#fafafa}
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h2>Stock Management</h2>
    <div class="small">Realtime stock, product dropdown from <code>products</code>, category filter & search</div>
  </div>

  <div style="display:flex;align-items:center;gap:12px">
    <div style="position:relative">
      <button id="bellBtn">ðŸ”” Low Stock <span id="lowCount" class="badge" style="display:none">0</span></button>
      <div id="lowDropdown" style="display:none;position:absolute;right:0;top:42px;background:#fff;padding:10px;border:1px solid #ddd;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.08);width:320px">
        <strong>Low Stock Items</strong>
        <div id="lowList" style="margin-top:8px"></div>
      </div>
    </div>

    <button onclick="location.href='stock-history.html'">View History</button>
  </div>
</div>

<div class="box">
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px">
    <select id="categoryFilter"><option value="all">All Categories</option></select>
    <select id="productSelect"><option value="">Select Product</option></select>
    <input id="qtyInput" type="number" placeholder="Quantity" style="width:120px"/>
    <button id="addBtn">Add Stock</button>

    <input id="searchBox" placeholder="Search product in table..." style="margin-left:auto;min-width:220px"/>
  </div>

  <table>
    <thead>
      <tr><th>#</th><th>Product</th><th>Category</th><th>Quantity</th><th>Status</th><th>Actions</th></tr>
    </thead>
    <tbody id="stockTable">
      <!-- rows -->
    </tbody>
  </table>
</div>

<div class="box">
  <h3>Recent Activity (Quick)</h3>
  <div id="recentActivity" class="history-list">Loading...</div>
</div>

<!-- Modules: history-logger.js initializes Firebase and exports db & helper functions -->
<script type="module" src="./history-logger.js"></script>
<!-- orders-listener must run to auto-decrement when orders placed -->
<script type="module" src="./orders-listener.js"></script>

<script type="module">
// admin-stock module logic
import { db, logHistory, getRecentHistory } from './history-logger.js';
import {
  collection, getDocs, onSnapshot, query, where, doc, updateDoc, addDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const productRef = collection(db, 'products');
const stockRef = collection(db, 'stock');

const productSelect = document.getElementById('productSelect');
const categoryFilter = document.getElementById('categoryFilter');
const qtyInput = document.getElementById('qtyInput');
const addBtn = document.getElementById('addBtn');
const stockTable = document.getElementById('stockTable');
const searchBox = document.getElementById('searchBox');
const lowCountEl = document.getElementById('lowCount');
const bellBtn = document.getElementById('bellBtn');
const lowDropdown = document.getElementById('lowDropdown');
const lowList = document.getElementById('lowList');
const recentActivity = document.getElementById('recentActivity');

let products = []; // array of product docs {id, name, category, price}
let stockItems = []; // array of stock docs

// load products -> populate category filter & product select
async function loadProducts(){
  productSelect.innerHTML = `<option value="">Select Product</option>`;
  categoryFilter.innerHTML = `<option value="all">All Categories</option>`;
  products = [];
  const snap = await getDocs(productRef);
  snap.forEach(d => {
    const data = d.data();
    products.push({ id: d.id, name: data.name, category: data.category || 'Uncategorized', price: data.price || 0 });
  });

  // categories
  const cats = [...new Set(products.map(p=>p.category))];
  cats.forEach(c => {
    categoryFilter.innerHTML += `<option value="${c}">${c}</option>`;
  });

  // products select grouped by category (simple)
  products.forEach(p => {
    productSelect.innerHTML += `<option value="${p.name}" data-cat="${p.category}">${p.name} (${p.category})</option>`;
  });
}

// helper status
function getStatus(q){
  if(q===0) return `<span class="status out-stock">Out of Stock</span>`;
  if(q < 10) return `<span class="status low-stock">Low Stock</span>`;
  return `<span class="status in-stock">In Stock</span>`;
}

// render stock table from snapshot
function renderStockTable(){
  const q = searchBox.value.trim().toLowerCase();
  const selectedCat = categoryFilter.value;
  let html = '';
  let idx = 1;
  stockItems.forEach(s => {
    if(selectedCat !== 'all' && s.category !== selectedCat) return;
    if(q && !s.product.toLowerCase().includes(q)) return;

    html += `<tr>
      <td>${idx++}</td>
      <td>${s.product}</td>
      <td>${s.category || ''}</td>
      <td>${s.quantity}</td>
      <td>${getStatus(s.quantity)}</td>
      <td class="actions">
        <button onclick="window.editStock('${s.id}', ${s.quantity})">Edit</button>
        <button onclick="window.deleteStock('${s.id}')">Delete</button>
      </td>
    </tr>`;
  });

  stockTable.innerHTML = html || `<tr><td colspan="6">No records</td></tr>`;
}

// load recent history (quick)
async function loadRecentHistory(){
  const rows = await getRecentHistory(8);
  if(!rows || rows.length===0){ recentActivity.innerHTML = 'No history yet.'; return; }
  recentActivity.innerHTML = rows.map(r=>{
    const time = new Date(r.time?.toDate?.() || Date.now()).toLocaleString();
    return `<div style="padding:8px;border-bottom:1px dashed #eee"><strong>${r.product}</strong> â€” ${r.action} â€” <span class="small">${r.oldQty ?? '-'} â†’ ${r.newQty ?? '-'} â€¢ ${time}</span></div>`;
  }).join('');
}

// subscribe to stock realtime
onSnapshot(stockRef, (snap)=>{
  stockItems = [];
  snap.forEach(d=>{
    const data = d.data();
    // try to attach category from products list (matching by name)
    const prod = products.find(p => p.name === data.product);
    stockItems.push({ id: d.id, product: data.product, quantity: data.quantity ?? 0, category: prod?.category || data.category || 'Uncategorized' });
  });
  // update low stock bell
  const low = stockItems.filter(s=>s.quantity < 10).length;
  if(low>0){ lowCountEl.style.display='inline-block'; lowCountEl.textContent = low; } else lowCountEl.style.display='none';
  // low list items
  lowList.innerHTML = stockItems.filter(s=>s.quantity<10).map(s=>`<div style="padding:6px;border-bottom:1px solid #f1f1f1"><strong>${s.product}</strong> â€” ${s.quantity}</div>`).join('') || '<div class="small">None</div>';
  renderStockTable();
});

// toggle low dropdown
bellBtn.addEventListener('click', ()=>{ lowDropdown.style.display = lowDropdown.style.display==='none'?'block':'none' });

// search & filters
searchBox.addEventListener('input', renderStockTable);
categoryFilter.addEventListener('change', renderStockTable);

// add stock (if product exists in stock, increment; else add new stock doc)
addBtn.addEventListener('click', async ()=>{
  const prodName = productSelect.value;
  const qty = Number(qtyInput.value);
  if(!prodName || !qty){ alert('Select product & quantity'); return; }

  // find stock doc where product == prodName
  const { query: qf, where: whereFn, getDocs: getDocsFn, collection: collectionFn } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
  // simple approach: find doc and update; we'll run a transaction for safety
  try {
    // find stock doc
    const q = qf(collection(db,'stock'), whereFn('product','==',prodName));
    const snap = await getDocsFn(q);
    if(snap.empty){
      // create new stock doc
      await addDoc(collection(db,'stock'), { product: prodName, quantity: qty });
      await logHistory({ action: 'added', product: prodName, oldQty: null, newQty: qty });
    } else {
      // update first match
      const sd = snap.docs[0];
      const old = sd.data().quantity || 0;
      await updateDoc(doc(db,'stock', sd.id), { quantity: old + qty });
      await logHistory({ action: 'added', product: prodName, oldQty: old, newQty: old + qty });
    }
    qtyInput.value = '';
  } catch(e){
    console.error(e); alert('Error adding stock');
  }
});

// expose edit/delete for buttons (global)
window.editStock = async function(id, oldQty){
  const n = prompt('New quantity:', oldQty);
  if(n===null) return;
  const newQty = Number(n);
  if(isNaN(newQty)) return alert('Invalid number');
  try{
    await updateDoc(doc(db,'stock',id), { quantity: newQty });
    const d = stockItems.find(s=>s.id===id);
    await logHistory({ action: 'updated', product: d?.product || 'Unknown', oldQty: oldQty, newQty });
  }catch(e){ console.error(e); alert('Update failed') }
};

window.deleteStock = async function(id){
  if(!confirm('Delete this stock record?')) return;
  try{
    // import deleteDoc
    const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js");
    await deleteDoc(doc(db,'stock',id));
    await logHistory({ action: 'deleted', product: (stockItems.find(s=>s.id===id)?.product) ?? 'Unknown', oldQty: (stockItems.find(s=>s.id===id)?.quantity) ?? null, newQty: null });
  }catch(e){ console.error(e); alert('Delete failed'); }
};

// initial load
await loadProducts();
await loadRecentHistory();

</script>
</body>
</html>
