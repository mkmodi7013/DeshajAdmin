<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Orders - Deshaj Store</title>

<style>
  body { font-family: Arial; background: #f7f7f7; padding: 20px; margin:0; }
  h2 { color: orange; text-align: center; margin-bottom: 10px; }

  /* Loader */
  #loader { text-align:center; margin-top:50px; font-size:18px; }

  /* Status Summary */
  .status-summary { display:flex; justify-content:space-around; padding:10px; background:#fff; margin-bottom:15px; border-radius:10px; box-shadow:0 0 8px #ccc; font-size:16px; font-weight:bold; cursor:pointer; }
  .pending { color: orange; }
  .processed { color: blue; }
  .delivered { color: green; }
  .allfilter { color: gray; }

  .controls { display:flex; justify-content:space-between; margin-bottom:15px; flex-wrap:wrap; gap:10px; }
  input { padding:6px 10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }

  .order-box { background:#fff; padding:15px; border-radius:10px; margin-bottom:15px; box-shadow:0 0 8px #ccc; }
  .order-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; }

  .status-badge { padding:3px 8px; border-radius:6px; color:#fff; font-size:12px; margin-left:10px; }
  .badge-pending { background: orange; }
  .badge-processed { background: blue; }
  .badge-delivered { background: green; }

  .items { margin-top:10px; max-height:200px; overflow-y:auto; }
  .item { display:flex; align-items:center; border-bottom:1px solid #ddd; padding:5px 0; gap:10px; }
  .item img { width:50px; height:50px; object-fit:cover; border-radius:4px; }
  select { padding:5px 8px; border-radius:6px; border:1px solid #ccc; }
  button.deleteBtn { background:#ff4d4f; color:#fff; border:none; padding:5px 10px; border-radius:6px; cursor:pointer; }
</style>
</head>

<body>


<h2>Admin — Orders Management</h2>

<!-- STATUS SUMMARY -->
<div class="status-summary">
  <span class="allfilter" id="allSummary">All: <span id="allCount">0</span></span>
  <span class="pending" id="pendingSummary">Pending: <span id="pendingCount">0</span></span>
  <span class="processed" id="processedSummary">Processed: <span id="processedCount">0</span></span>
  <span class="delivered" id="deliveredSummary">Delivered: <span id="deliveredCount">0</span></span>
</div>

<div class="controls">
  <input type="text" id="searchInput" placeholder="Search by name, mobile or order ID...">
</div>

<div id="loader">Loading orders...</div>
<div id="ordersList" style="display:none;"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6izuR2_oyHbAVhkIVkH0OHj6yAOduD_8",
  authDomain: "apna-kitchen-acdcc.firebaseapp.com",
  projectId: "apna-kitchen-acdcc",
  storageBucket: "apna-kitchen-acdcc.appspot.com",
  messagingSenderId: "129562055761",
  appId: "1:129562055761:web:baa01f9fea6f8eed025470"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let allOrders = [];
let activeFilter = "ALL";

// -------- AUTH CHECK --------
onAuthStateChanged(auth, (user) => {
  if(!user || user.email !== "mkmodi7013@gmail.com") {
    window.location.href = "index.html";
  } else {
    fetchOrders();
  }
});

// -------- FETCH ORDERS --------
async function fetchOrders(){
  const list = document.getElementById("ordersList");
  const loader = document.getElementById("loader");
  loader.style.display = "block";
  list.style.display = "none";

  const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
  const snap = await getDocs(q);
  allOrders = [];

  for(const d of snap.docs){
    const order = d.data();
    order.id = d.id;

    let user = { name:"-", mobile: order.mobile, address:"-", pincode:"-" };
    if(order.mobile){
      const u = await getDoc(doc(db, "users", order.mobile));
      if(u.exists()) user = u.data();
    }

    order.user = user;
    if(!order.status) order.status = "Pending";
    allOrders.push(order);
  }

  loader.style.display = "none";
  list.style.display = "block";

  updateStatusSummary();
  displayOrders(activeFilter);
}

// -------- UPDATE STATUS SUMMARY --------
function updateStatusSummary(){
  let p=0, pr=0, d=0;
  allOrders.forEach(o=>{
    if(o.status==="Pending") p++;
    else if(o.status==="Processed") pr++;
    else if(o.status==="Delivered") d++;
  });
  document.getElementById("pendingCount").innerText = p;
  document.getElementById("processedCount").innerText = pr;
  document.getElementById("deliveredCount").innerText = d;
  document.getElementById("allCount").innerText = allOrders.length;
}

// -------- DISPLAY ORDERS --------
function displayOrders(filter = activeFilter){
  const list = document.getElementById("ordersList");
  const search = document.getElementById("searchInput").value.toLowerCase();

  let filtered = allOrders.slice();
  if(filter !== "ALL") filtered = filtered.filter(o => o.status === filter);

  filtered = filtered.filter(o =>
    o.user.name?.toLowerCase().includes(search) ||
    o.user.mobile?.toLowerCase().includes(search) ||
    o.id.toLowerCase().includes(search)
  );

  if(filtered.length === 0){
    list.innerHTML = "<p style='text-align:center;'>No orders found</p>";
    return;
  }

  list.innerHTML = "";
  filtered.forEach(order=>{
    let itemsHTML = "";
    (order.items || []).forEach(i=>{
      itemsHTML += `<div class="item">
        <img src="${i.image || 'https://via.placeholder.com/50'}" />
        <span>${i.name} (x${i.qty})</span>
        <span>₹${i.price*i.qty}</span>
      </div>`;
    });

    const badgeClass = order.status==="Pending" ? "badge-pending" : order.status==="Processed" ? "badge-processed" : "badge-delivered";

    list.innerHTML += `<div class="order-box" id="box-${order.id}">
      <div class="order-header">
        <p><strong>${order.user.name}</strong> | ${order.user.mobile} | ID: ${order.id}
          <span class="status-badge ${badgeClass}">${order.status}</span>
        </p>
        
        <button style="background:green;color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;"
      onclick="window.location.href='invoice.html?id=${order.id}'">
      Invoice
    </button>
        <p>Total: ₹${order.total || 0}</p>
        <select onchange="updateStatus('${order.id}', this.value)">
          <option value="Pending" ${order.status==="Pending"?"selected":""}>Pending</option>
          <option value="Processed" ${order.status==="Processed"?"selected":""}>Processed</option>
          <option value="Delivered" ${order.status==="Delivered"?"selected":""}>Delivered</option>
        </select>
        <button class="deleteBtn" onclick="deleteOrder('${order.id}')">Delete</button>
      </div>
      <p><strong>Address:</strong> ${order.user.address}, Pincode: ${order.user.pincode}</p>
      <p><strong>Order Date:</strong> ${order.timestamp ? order.timestamp.toDate().toLocaleString() : "-"}</p>
      <div class="items">${itemsHTML}</div>
    </div>`;
  });
}

// -------- UPDATE ORDER STATUS --------
window.updateStatus = async function(orderId, status){
  await updateDoc(doc(db, "orders", orderId), { status });
  fetchOrders();
}

// -------- DELETE ORDER --------
window.deleteOrder = async function(orderId){
  if(confirm("Are you sure you want to delete this order?")){
    await deleteDoc(doc(db, "orders", orderId));
    fetchOrders();
  }
}

// -------- SEARCH & FILTER EVENTS --------
document.getElementById("searchInput").addEventListener("input", ()=>displayOrders(activeFilter));

document.getElementById("allSummary").addEventListener("click", ()=>{ activeFilter="ALL"; displayOrders(); });
document.getElementById("pendingSummary").addEventListener("click", ()=>{ activeFilter="Pending"; displayOrders(); });
document.getElementById("processedSummary").addEventListener("click", ()=>{ activeFilter="Processed"; displayOrders(); });
document.getElementById("deliveredSummary").addEventListener("click", ()=>{ activeFilter="Delivered"; displayOrders(); });
</script>

</body>
</html>
